<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='https://cdn.firebase.com/js/client/2.0.4/firebase.js'></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script>

var state = {
    local : {},
    proposals : [
        {
            text : 'hi there!'
        }
    ]
}

function saveLocal() {
    try {
        localStorage[window.location.href] = _.json(state.local)
    } catch (e) {}
}

function loadLocal() {
    try {
        _.merge(state.local, _.unJson(localStorage[window.location.href]))
    } catch (e) {}
    if (!state.local.user) {
        state.local.user = _.randomString(10)
        saveLocal()
    }
}

function drawProposal(p) {
    var d = $('<div style="-moz-border-radius: 15px;border-radius: 15px; background: grey"/>')
    d.append($('<div/>').text(p.text))
    return d
}

function redrawEverything() {
    var d = $('<div/>')
    
    _.each(state.proposals, function (p) {
        d.append(drawProposal(p))
    })

    d.append($('<div/>').text('here now: ' + state.hereNow))

    $('body').empty().append(d)
}

$(function () {
    console.log('version 2')
    $('body').css('margin', '0px')
    
    loadLocal()

    fb = new Firebase('https://proposals22.firebaseio.com/')
    var me = fb.child('hereNow/' + state.local.user)
    me.set(true)
    me.onDisconnect().set(null)
    
    fb.on('value', function (x) {
        state.fb = x.val()
        
        // work here
        console.log(state)
        
        state.hereNow = _.values(get(state, 'fb', 'hereNow')).length
        redrawEverything()
    })
})

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

function get() {
    var a = arguments
    var x = a[0]
    for (var i = 1; x && i < a.length; i++) x = x[a[i]]
    return x
}

$.fn.transform = function (s) {
    this.css({
        '-ms-transform' : s,
        '-moz-transform' : s,
        '-webkit-transform' : s,
        '-o-transform' : s
    })
    return this
}

function toColor(a) {
    return 'rgb(' + _.map(a, function (x) { return Math.floor(x) }).join(',') + ')'
}

function randomColors() {
    var colors = []

    var a = [255, 128, _.lerp(0, 128, 1, 255, Math.random())]
    _.shuffle(a)
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/4) })
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/3) })
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/2) })
    colors.push(toColor(a))
    
    return colors
}

function drawGameDiv(widthOverHeight, fontSize) {
    var w1 = window.innerWidth
    var h1 = window.innerHeight
    if (w1/h1 > widthOverHeight) {
        var h = h1
        var w = widthOverHeight * h
    } else {
        var w = w1
        var h = w / widthOverHeight
    }

    var d = $('<div/>').css({
        position : 'absolute',
        left : '50%',
        top : '50%',
        width : w + 'px',
        height : h + 'px',
        margin : '-' + (h/2) + 'px 0 0 -' + (w/2) + 'px',
        fontSize : fontSize * w + 'px'
    })

    $.fn.setPos = function (x, y, _w, _h) {
        return this.css({
            position : 'absolute',
            left : x * w + 'px',
            top : y * h + 'px',
            width : _w * w + 'px',
            height : _h * h + 'px'
        })
    }

    return d
}

</script>
</body>
</html>
