<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='https://cdn.firebase.com/js/client/2.0.4/firebase.js'></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="http://dglittle.github.io/gl519/random.js"></script>
<script src="http://dglittle.github.io/gl519/aes.js"></script>
<script src="http://dglittle.github.io/gl519/md5.js"></script>
<script>

var state = {}
var g = {}

function initState() {
    state = {
        board : [[null, null, null], [null, null, null, null, null], [null, null, null, null, null]],
        available : [],
        discarded : [],
        availableHistory : [],
        theirBoardHistory : []
    }
}

function pickCards(n, seed) {
    var usedCards = {}
    function f(a) {
        _.each(a, function (a) { if (a) usedCards[a.slice(0, 2)] = true })
    }
    _.each(state.board, f)
    f(state.available)
    f(state.discarded)
    
    var cards = []
    _.each('shcd', function (s) {
        _.each('23456789TJQK', function (v) {
            var card = v + s
            if (!usedCards[card]) cards.push(card)
        })
    })
    
    var oldRandom = Math.random
    Math.randomSeed(seed)
    _.shuffle(cards)
    Math.random = oldRandom
    
    state.available = cards.slice(0, n)
    state.availableHistory.push(_.clone(state.available))
}

function progressGame() {
    _.each(state.board, function (row) {
        _.each(row, function (card, x) {
            if (card) row[x] = card + '_'
        })
    })
    _.each(state.available, function (card, x) {
        if (card) state.discarded.push(card)
    })
    state.available = pickCards(3, 333)
}

function drawSlot(x, y, onPlaceCardHere) {
    var d = $('<div style="border:1px solid black;border-radius:' + g.D.getX(.025) + 'px;"/>')
    g.D.setPos(d, x, y, .2, .2)
    if (onPlaceCardHere) {
        d.addClass('slot')
        d[0].isIn = function (pos) {
            var xy = getPos(d)
            var wh = getSize(d)
            return pos[0] > xy[0] && pos[1] > xy[1] && pos[0] < xy[0] + wh[0] && pos[1] < xy[1] + wh[1]
        }
        d[0].placeCardHere = onPlaceCardHere
    }
    return d
}

function drawCard(card, x, y, onRemove) {
    var d = $('<div style="border-radius:' + g.D.getX(.025) + 'px;background:white"/>')
    var draggable = card[2] != '_'
    d.css('border', '1px solid black')
    if (draggable) d.css('background', 'gold')
    g.D.setPos(d, x, y, .2, .2)
    var suits = { 's' : '♠', 'h' : '♥', 'd' : '♦', 'c' : '♣' }
    d.append($('<div style="font-size:150%"/>').text((card[0] == 'T' ? '10' : card[0] ) + suits[card[1]]))
    if (draggable)
        makeDraggable(d, function (pos) {
            _.each($('.slot').get(), function (s) {
                if (s.isIn(pos)) {
                    s.placeCardHere(card)
                    onRemove()
                    return false
                }
            })
            g.redraw()
        })
    return d
}

function drawBoard(cb) {
    var d = $('<div/>')
    
    function drawCardHelper(card, x, y, array, index) {
        d.append(drawSlot(x * .2, y * .2, card ? null : function (card) {
            array[index] = card
        }))
        if (card)
            d.append(drawCard(card, x * .2, y * .2, function () {
                array[index] = null
            }))
    }
    _.each(state.board, function (row, y) {
        _.each(row, function (card, x) {
            drawCardHelper(card, x, y, row, x)
        })
    })
    _.each(state.available, function (card, x) {
        drawCardHelper(card, x, 3, state.available, x)
    })
    
    if ((state.available.length == 5 && !_.any(state.available)) || (state.available.length == 3 && _.filter(state.available).length == 1)) {
        var done = $('<div style="border:1px solid black;border-radius:' + g.D.getX(.025) + 'px;background:gold"/>').text('done').click(cb)
        g.D.setPos(done, .6, .6, .4, .2)
        d.append(done)
    }

    return d
}

function joinGame(cb) {
    var lobby = fb.child('lobby')
    lobby.once('value', function (x) {
        x = x.val()
        var found = false
        _.each(x, function (v, them) {
            if (!v) {
                var room = _.randomString(10)
                lobby.child(them).transaction(function (v) {
                    if (!v) return  { room : room, user : user }
                }, function (bad, good) {
                    if (!bad && good) {
                        cb(room, them)
                    } else {
                        joinGame(cb)
                    }
                })
                found = true
                return false
            }
        })
        if (!found) {
            var wait = lobby.child(user)
            wait.set(false)
            waitOn(wait, 2000 + Math.random() * 5000, function (x) {
                wait.set(null)
                if (x) {
                    cb(x.room, x.user)
                } else {
                    joinGame(cb)
                }
            })
        }
    })
}

function setGameState(s) {
    if (s == 'findGame') {
        joinGame(function (room, them) {
            state.room = room
            state.them = them
            setGameState('waitForSeed1')
        })
    }
    if (s == 'waitForSeed1') {
        console.log('got here??')
        
        var seed = _.randomString(10)
        fb.child('rooms/' + state.room + '/' + user + '/seed1').set(seed)
        waitOn(fb.child('rooms/' + state.room + '/' + state.them + '/seed1'), 5000, function (x) {
            if (x) {
                initState()
                pickCards(5, [seed, x].sort().join(','))
                setGameState('placeCards1')
            } else {
                setGameState('findGame')
            }
        })
    }
    if (s == 'placeCards1') {
        state.time = _.time()
        $('body').empty()
        g.D = drawGameDiv(100/125, .07)
        g.D.css('background-color', 'green')
        g.redraw = function () {
            g.D.empty().append(drawBoard(function () {
                setGameState('waitForHash1')
            }))
        }
        g.redraw()
        $('body').append(g.D)
    }
    if (s == 'waitForHash1') {
        var hash = md5(_.json(state))
        fb.child('rooms/' + state.room + '/' + user + '/hash1').set(hash)
        waitOn(fb.child('rooms/' + state.room + '/' + state.them + '/hash1'), state.time + 20000 - _.time(), function (x) {
            if (x) {
                g.theirHash1 = x
                setGameState('waitForVerify1')
            } else {
                setGameState('findGame')
            }
        })
    }
    if (s == 'waitForVerify1') {
        var verify = _.json(state)
        fb.child('rooms/' + state.room + '/' + user + '/verify1').set(verify)
        waitOn(fb.child('rooms/' + state.room + '/' + state.them + '/verify1'), 5000, function (x) {
            if (x && md5(x) == g.theirHash1) {
                work here
                
                
                g.theirHash1 = x
                setGameState('waitForVerify1')
            } else {
                setGameState('findGame')
            }
        })
    }
    if (s == 'placeFirstThreeCards') {
        $('body').empty()
        g.D = drawGameDiv(100/125, .07)
        g.D.css('background-color', 'green')
        g.redraw = function () {
            g.D.empty().append(drawBoard(function () {
                setGameState('placeFirstThreeCards')
                
            }))
        }
        g.redraw()
        $('body').append(g.D)
    }
}

$(function () {
    console.log('version 1')
    
    $('<style> html { box-sizing: border-box; } *, *:before, *:after { box-sizing: inherit; } body { margin: 0px } </style>').appendTo('head')
    
    user = _.randomString(10)
    fb = new Firebase('https://myofc.firebaseio.com/')
    fb.child('lobby/' + user).onDisconnect().set(null)
    
    // work here
    setTimeout(function () {
        setGameState('findGame')
    }, Math.random() * 2000)
})

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

function waitOn(ref, forThisLong, cb) {
    var f = function (x) {
        setTimeout(function () {
            x = x.val()
            if (x) {
                ref.off('value', f)
                clearTimeout(t)
                cb(x)
            }
        }, 0)
    }
    ref.on('value', f)
    var t = setTimeout(function () {
        ref.off('value', f)
        cb(null)
    }, forThisLong)
}

function get() {
    var a = arguments
    var x = a[0]
    for (var i = 1; x && i < a.length; i++) x = x[a[i]]
    return x
}

$.fn.transform = function (s) {
    this.css({
        '-ms-transform' : s,
        '-moz-transform' : s,
        '-webkit-transform' : s,
        '-o-transform' : s
    })
    return this
}

function drawGameDiv(widthOverHeight, fontSize) {
    var w1 = window.innerWidth
    var h1 = window.innerHeight
    if (w1/h1 > widthOverHeight) {
        var h = h1
        var w = widthOverHeight * h
    } else {
        var w = w1
        var h = w / widthOverHeight
    }

    var d = $('<div/>')
    
    d.getX = function (x) { return x * w }
    d.getY = function (y) { return y * h }
    
    d.css({
        position : 'absolute',
        left : '50%',
        top : '50%',
        width : w + 'px',
        height : h + 'px',
        margin : '-' + (h/2) + 'px 0 0 -' + (w/2) + 'px',
        fontSize : d.getX(fontSize) + 'px'
    })

    d.setPos = function (D, x, y, w, h) {
        D.css({
            position : 'absolute',
            left : d.getX(x) + 'px',
            top : d.getY(y) + 'px',
            width : d.getX(w) + 'px',
            height : d.getY(h) + 'px'
        })
    }

    return d
}

function getPos(x) {
    if ('pageX' in x) return [x.pageX, x.pageY]
    if ('left' in x) return [x.left, x.top]
    if ('offset' in x) return getPos(x.offset())
    return x
}

function getSize(x) {
    return [x.width(), x.height()]
}

function makeDraggable(d, onDrop) {
	function setPos(d, pos) {
		d.offset({ left : pos[0], top : pos[1] })
	}
	d.mousedown(function (e) {
		e.preventDefault()
		var pos = getPos(d)
		var oldParent = d.parent()
		$('body').append(d)
		setPos(d, pos)
		var lastMousePos = getPos(e)
		var mousemove = function (e) {
			var mousePos = getPos(e)
			var delta = sub(mousePos, lastMousePos)
			lastMousePos = mousePos
			setPos(d, add(getPos(d), delta))
		}
		var mouseup = function (e) {
			$(document).off('mousemove', mousemove).off('mouseup', mouseup)
			pos = getPos(d)
			oldParent.append(d)
			setPos(d, pos)
			onDrop(lastMousePos)
		}
		$(document).on('mousemove', mousemove).on('mouseup', mouseup)
	})
	d.on('touchstart', function (e) {
		e = e.originalEvent
		e.preventDefault()
		var pos = getPos(d)
		var oldParent = d.parent()
		$('body').append(d)
		setPos(d, pos)
		var lastMousePos = getPos(e.touches[0])
		var mousemove = function (e) {
			e = e.originalEvent
			e.preventDefault()
			var mousePos = getPos(e.touches[0])
			var delta = sub(mousePos, lastMousePos)
			lastMousePos = mousePos
			setPos(d, add(getPos(d), delta))
		}
		var mouseup = function (e) {
			e = e.originalEvent
			e.preventDefault()
			$(document).off('touchmove', mousemove).off('touchend', mouseup)
			pos = getPos(d)
			oldParent.append(d)
			setPos(d, pos)
			onDrop(lastMousePos)
		}
		$(document).on('touchmove', mousemove).on('touchend', mouseup)
	})
}

function isMobile() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
}

function isRetina() {
    return window.devicePixelRatio > 1
}

function getWindowSize() {
    return [window.innerWidth, window.innerHeight]
}

function createCheckBox(label, check, cb) {
    var d = $('<span/>')

    var c = $('<input type="checkbox"/>')
    var id = _.randomString(10, /[a-z]/)
    c.attr('id', id)
    c.prop('checked', !!check)
    if (cb) c.change(cb)
    d.append(c)

    if (typeof(label) == "string") label = $('<span/>').text(label)
    d.append($('<label for="' + id + '"/>').append(label))

    return d
}

function grabMouse(d, cb, onUp) {
    d.on('mousedown', function (e) {
        e.preventDefault()
        cb(getRelPos(d, e))

        var oldMove = document.onmousemove
        document.onmousemove = function (e) {
            cb(getRelPos(d, e))
        }
        
        var oldUp = document.onmouseup
        document.onmouseup = function (e) {
            if (onUp) onUp()
            document.onmousemove = oldMove
            document.onmouseup = oldUp
        }
    })
    d.on('touchstart', function (e) {
        e.preventDefault()
        cb(getRelPos(d, e.originalEvent.touches[0]))

        var oldMove = document.ontouchmove
        document.ontouchmove = function (e) {
            e.preventDefault()
            cb(getRelPos(d, e.touches[0]))
        }

        var oldEnd = document.ontouchend;
        var oldCancel = document.ontouchcancel
        document.ontouchend = document.ontouchcancel = function (e) {
            if (onUp) onUp()
            document.ontouchmove = oldMove
            document.ontouchend = oldEnd
            document.ontouchcancel = oldCancel
        }
    })
}

function grabMouseRelative(d, onDown, cb, onUp) {
    var lastPos = null
    grabMouse(d, function (pos) {
        if (!lastPos) {
            if (onDown) onDown(pos)
        } else {
            cb(sub(pos, lastPos), pos)
        }
        lastPos = pos
    }, function () {
        if (onUp) onUp(lastPos[0], lastPos[1])
        lastPos = null
    })
}

var tau = Math.PI * 2

function zeros(n) {
    var sum = []
    for (var i = 0; i < n; i++)
        sum.push(0)
    return sum
}

function sum(x) {
    var sum = 0
    for (var i = 0; i < x.length; i++)
        sum += x[i]
    return sum
}

function op(x, y, op) {
    var sum = []
    var n = (x instanceof Array) ? x.length : y.length
    for (var i = 0; i < n; i++) {
        sum.push(op(
            (x instanceof Array) ? x[i] : x,
            (y instanceof Array) ? y[i] : y))
    }
    return sum
}

function sub(x, y) {
    return op(x, y, function (x, y) { return x - y })
}

function add(x, y) {
    return op(x, y, function (x, y) { return x + y })
}

function mul(x, y) {
    return op(x, y, function (x, y) { return x * y })
}

function div(x, y) {
    return op(x, y, function (x, y) { return x / y })
}

function dot(x, y) {
    return sum(mul(x, y))
}

function distSq(x, y) {
    if (y !== undefined) return distSq(sub(x, y))
    return dot(x, x)
}
magSq = distSq

function dist(x, y) {
    return Math.sqrt(distSq(x, y))
}
mag = dist

function norm(x) {
    return div(x, dist(x))
}

function matmul(a, b) {
    var m = []
    for (var r = 0; r < a.length; r++) {
        m[r] = []
        for (var c = 0; c < b[0].length; c++) {
            m[r][c] = 0
            for (var i = 0; i < b.length; i++) {
                m[r][c] += a[r][i] * b[i][c]
            }
        }
    }
    return m
}

function comparator(f, desc) {
    return function (a, b) {
        if (f) {
            a = f(a)
            b = f(b)
        }
        if (a < b) return desc ? 1 : -1
        if (a > b) return desc ? -1 : 1
        return 0
    }
}

</script>
</body>
</html>
