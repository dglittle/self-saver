
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script>

$(function () {
	var f = $('<iframe name="haha" />')
	$('body').append(f)

	var form = $('<form action="http://odoserver.herokuapp.com/rpc" target="haha" method="post" enctype="multipart/form-data"/>')
	form.append($('<input type="file" name="hihi" accept="image/*" capture="camera"/>'))

	form.append($('<input type="hidden" name="site" value="http://dglittle.github.io/self-saver/imitation-selfie.html"/>'))
	form.append($('<input type="hidden" name="func"/>').attr('value', '' + /* server begin */function (a, b, req) {
	    
		return '<script>window.parent.postMessage("' +
		    req.files.hihi.buffer.toString('base64') +
		    '", "*")<'+'/script>'
	}/* server end */))
	form.append($('<input type="hidden" name="args" value="[4,38]"/>'))

	form.append($('<input type="submit" id="hithere">'))
	$('body').append(form)
	
	addEventListener("message", function (e) {
	    $('body').append($('<img/>').attr('src', 'data:image/jpg;base64,' + e.data))
	}, false)


	
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia
    window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL
    window.requestAnimationFrame = window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame || function (cb) { window.setTimeout(cb, 1000 / 60) }
        
    if (navigator.getUserMedia) {
        var video = $('<video/>')
        $('body').append(video)
        video = video[0]
        navigator.getUserMedia({video: true}, function (stream) {
            if (video.mozSrcObject !== undefined)
                video.mozSrcObject = stream
            else
                video.src = (window.URL && window.URL.createObjectURL(stream)) || stream
            video.play()
        }, function () {});
    	$('body').append($('<button/>').text('snapshot').click(function () {
    	    var w = video.videoWidth
    	    var h = video.videoHeight
            var c = $('<canvas/>').attr('width', w).attr('height', h)
            var g = c[0].getContext('2d')
            g.drawImage(video, 0, 0, w, h)
            $('body').append(c)
    	}))
    }

})

</script>
