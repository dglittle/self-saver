<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no">
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src='https://cdn.firebase.com/js/client/2.0.4/firebase.js'></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script>

var state = {
    hereNow : 0,
    questions : new Array(4)
}

var config = {
    margin : .2
}

function drawLeftText(text, color, background, i) {
    var m = config.margin
    var x = m/100
    var y = i * 1/6 + m/125
    var h = 1/6 - 2*m/125
    var d = $('<div/>').
        css({ 'background-color' : background, color : color }).
        setPos(x, y, .6 - 2*m/100, h)

    var t = $('<div/>').css('width', d.css('width'))
    t.text(text)
    D.append(t)
    var per = 100
    while (t.height() > d.height()) {
        per -= 10
        t.css('font-size', per + '%')
    }
    d.append(t)
    
    return d
}

function drawWhiteResults(i, html) {
    var m = config.margin
    var y = i * 1/6 + m/125
    var h = 1/6 - 2*m/125
    return $('<div/>').setPos(.6 + m/100, y, .4 - 2*m/100, h).
        css({
            'font-size' : '50%',
            'color' : 'white',
            'font-family' : 'monospace',
            'padding-top' : 1/125*D.height() + 'px'
        }).
        html(html)
}

function drawHeader() {
    var d = $('<div/>')
    d.append(drawLeftText('yes no game', 'white', 'rgb(100,100,100)', 0))
    try {
        d.append(drawWhiteResults(0, 'players now: ' + state.hereNow))
    } catch (e) {}
    return d
}

function drawButton(i, ii, text, background, color, func) {
    var m = config.margin
    var y = i * 1/6 + m/125
    var h = 1/6 - 2*m/125
    return $('<div style="background-color:' + background + '"/>').
        setPos(.6 + .4/3*ii + m/100, y, .4/3 - 2*m/100, h).
        transform('rotate(' + 5*(ii+1) + 'deg)').
        css('font-size', '60%').
        css('color', color || 'black').
        html(text).
        click(func)
}

function drawQuestion(q, i) {
    var cs = randomColors()
    var d = $('<div/>')
    d.append(drawLeftText(q, 'black', cs[0], i))
    
    var m = config.margin
    var y = i * 1/6 + m/125
    var h = 1/6 - 2*m/125
    _.each(['yes', 'no', 'skip'], function (text, ii) {
        d.append(drawButton(i, ii, text, cs[ii + 1]))
    })
    return d
}

function drawQuestionResults(q, yes, no, i, askFunc) {
    var cs = randomColors()
    var d = $('<div/>')
    d.append(drawLeftText(q, 'black', cs[0], i))
    d.append(drawWhiteResults(i, '' + Math.floor(100*(yes/(yes + no))) + '%<br/>' + yes + '/' + (yes + no)))
    
    if (askFunc) {
        d.append(drawButton(i, 2, 'ask<br/>new', cs[3], 'white', askFunc))
    }
    
    return d
}

function redrawEverything() {
    var d = $('<div/>')
    d.append(drawHeader())
    _.each(state.questions, function (q, i) {
        q = state.fb.questions[q]
        if (!q) return
        d.append(drawQuestion(q.text, i + 1))
        // d.append(drawQuestionResults(q.text, q.yes, q.no, i + 1))
    })
    d.append(drawQuestionResults('nothing', 2, 4, 5, function () {
        var q = prompt('enter a yes or no question:')
        if (q) {
            var blah = fb.child('questions').push({
                text : q,
                yes : 0,
                no : 0,
                skip : 0,
                time : _.time()
            }).key()
            console.log('blah', blah)
        }
    }))
    D.empty().append(d)
}

function getUser() {
    try {
        return localStorage.user ||
            (localStorage.user = _.randomString(10))
    } catch (e) {
        return _.randomString(10)
    }
}

$(function () {
    $('body').css('margin', '0px')
    $('body').css('background-color', 'black')
    D = drawGameDiv(100/125, .07)
    $('body').append(D)
    
    state.user = getUser()

    fb = new Firebase('https://yesnogame.firebaseio.com/')
    var me = fb.child('hereNow/' + state.user)
    me.set(true)
    me.onDisconnect().set(null)
    
    fb.on('value', function (x) {
        state.fb = x.val()
        var redraw = false
        
        var newHereNow = _.values(get(state, 'fb', 'hereNow')).length
        if (state.hereNow != newHereNow) {
            state.hereNow = newHereNow
            redraw = true
        }
        
        while (_.any(state.questions, function (q) { return q == null })) {
            var found = false
            _.each(get(state, 'fb', 'questions'), function (q, key) {
                if (state.questions.indexOf(key) >= 0) return
                _.each(state.questions, function (q, i) {
                    if (!q) {
                        state.questions[i] = key
                        redraw = true
                        found = true
                        return false
                    }
                })
                if (found) return false
            })
            if (!found) break
        }
        if (redraw) redrawEverything()
    })
})

//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////

function get() {
    var a = arguments
    var x = a[0]
    for (var i = 1; x && i < a.length; i++) x = x[a[i]]
    return x
}

$.fn.transform = function (s) {
    this.css({
        '-ms-transform' : s,
        '-moz-transform' : s,
        '-webkit-transform' : s,
        '-o-transform' : s
    })
    return this
}

function toColor(a) {
    return 'rgb(' + _.map(a, function (x) { return Math.floor(x) }).join(',') + ')'
}

function randomColors() {
    var colors = []

    var a = [255, 128, _.lerp(0, 128, 1, 255, Math.random())]
    _.shuffle(a)
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/4) })
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/3) })
    colors.push(toColor(a))
    
    a = _.map(a, function (x) { return _.lerp(0, x, 1, 0, 1/2) })
    colors.push(toColor(a))
    
    return colors
}

function drawGameDiv(widthOverHeight, fontSize) {
    var w1 = window.innerWidth
    var h1 = window.innerHeight
    if (w1/h1 > widthOverHeight) {
        var h = h1
        var w = widthOverHeight * h
    } else {
        var w = w1
        var h = w / widthOverHeight
    }

    var d = $('<div/>').css({
        position : 'absolute',
        left : '50%',
        top : '50%',
        width : w + 'px',
        height : h + 'px',
        margin : '-' + (h/2) + 'px 0 0 -' + (w/2) + 'px',
        fontSize : fontSize * w + 'px'
    })

    $.fn.setPos = function (x, y, _w, _h) {
        return this.css({
            position : 'absolute',
            left : x * w + 'px',
            top : y * h + 'px',
            width : _w * w + 'px',
            height : _h * h + 'px'
        })
    }

    return d
}

</script>
</body>
</html>
